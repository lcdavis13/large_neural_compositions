import os
import subprocess
import csv

# User Config: Toggle between parallel or single-job execution of folds
NUM_FOLDS = 5  # Number of folds

# Default values for parameters missing from the configuration table
DEFAULT_VALUES = {
    "interpolate": "0",
    "hidden_dim": "8",
    "ffn_dim_multiplier": "4",
    "ode_steps": "15"
}

# Load configurations table from a CSV-like input
configurations_table = """lr,reptile_rate,noise,attend_dim_per_head,num_heads,depth,dropout,wd_factor
0.0032,1.0,0.075,6,2,16,0.1,0.0
0.0032,0.5,0,6,8,16,0.1,2.0
0.0032,1.0,0,4,8,16,0.1,0.0
0.0032,1.0,0,6,2,16,0.1,0.0
0.0032,0.5,0.075,4,8,16,0.1,2.0
0.0032,0.5,0.075,6,8,16,0.1,0.0
0.0032,0.5,0,6,8,4,0.1,0.0
0.0032,0.5,0,4,8,16,0.1,0.0
0.0032,0.1,0,4,8,16,0.1,2.0
0.0032,0.1,0,4,8,16,0.1,0.0
0.0032,1.0,0.075,4,8,16,0.1,2.0
0.0032,0.5,0,6,2,16,0.1,0.0
0.0032,0.1,0,4,8,4,0.1,2.0
0.0032,1.0,0,6,8,4,0.1,2.0
0.0032,1.0,0.075,6,8,4,0.1,0.0
0.0032,1.0,0,4,8,4,0.1,2.0
0.0032,0.1,0.075,6,8,16,0.1,0.0
0.0032,1.0,0.075,4,8,16,0.1,0.0
0.0032,0.1,0,6,8,4,0.1,0.0
0.0032,1.0,0,6,2,4,0.1,0.0
0.0032,0.5,0.075,4,8,4,0.1,2.0
0.0032,0.5,0.075,4,8,4,0.1,0.0
0.0032,0.5,0,4,8,4,0.1,0.0
0.0001,1.0,0,6,8,16,0.1,0.0
0.0032,0.1,0.075,6,8,4,0.1,0.0
0.0032,0.1,0.075,4,8,4,0.1,0.0
0.0032,1.0,0.075,6,2,4,0.1,0.0
0.0001,1.0,0,4,8,16,0.1,0.0
0.0032,1.0,0,6,8,4,0.1,0.0
0.0032,0.5,0.075,6,8,4,0.1,0.0
0.0032,0.1,0.075,4,8,16,0.1,0.0
0.0032,0.5,0.075,4,8,16,0.1,0.0
0.0032,1.0,0.075,6,2,4,0.1,2.0
0.0032,0.1,0.075,6,8,4,0.1,2.0
0.0001,1.0,0,6,8,16,0.1,2.0
0.0032,0.1,0,4,8,4,0.1,0.0
0.0032,0.1,0,6,8,4,0.1,2.0
0.0032,0.1,0.075,6,8,16,0.1,2.0
0.0032,1.0,0,4,8,4,0.5,2.0
0.0032,0.1,0,4,8,16,0.5,0.0
0.0032,0.5,0,4,8,4,0.1,2.0
0.0001,1.0,0.075,6,8,16,0.1,2.0
0.0032,1.0,0,4,8,4,0.1,0.0
0.0001,1.0,0.075,6,8,16,0.1,0.0
0.0032,0.1,0,4,8,16,0.5,2.0
0.0032,1.0,0.075,4,8,4,0.1,2.0
0.0032,0.1,0,6,8,16,0.1,0.0
0.0032,1.0,0.075,6,8,4,0.1,2.0
0.0032,0.1,0,6,8,16,0.1,2.0
0.0032,0.5,0,6,8,4,0.1,2.0
0.0032,1.0,0.075,6,2,16,0.1,2.0
0.0032,1.0,0,6,2,16,0.1,2.0
0.0032,0.1,0.075,4,8,16,0.1,2.0
0.0032,0.5,0.075,4,8,4,0.5,0.0
0.0032,0.1,0,6,2,16,0.1,0.0
0.0032,0.1,0.075,4,8,4,0.5,0.0
0.0032,1.0,0.075,4,2,4,0.1,2.0
0.0032,1.0,0.075,4,2,16,0.1,2.0
0.0032,0.5,0.075,6,8,4,0.1,2.0
0.0032,0.5,0.075,6,2,16,0.1,2.0
0.0032,0.1,0,4,8,4,0.5,2.0
0.0032,1.0,0,4,2,16,0.1,0.0
0.0032,0.1,0.075,4,8,4,0.1,2.0
0.0032,1.0,0.075,4,8,4,0.1,0.0
0.0032,0.5,0,4,8,4,0.5,0.0
0.0032,1.0,0.075,4,2,4,0.1,0.0
0.0032,1.0,0.075,4,8,4,0.5,2.0
0.0032,1.0,0,4,2,16,0.1,2.0
0.0032,1.0,0,6,2,4,0.1,2.0
0.0032,0.5,0.075,4,8,4,0.5,2.0
0.0032,1.0,0,6,2,4,0.5,0.0
0.0001,1.0,0,4,8,16,0.1,2.0
0.0032,0.5,0.075,6,2,16,0.1,0.0
0.0032,0.1,0,4,8,4,0.5,0.0
0.0032,0.1,0,6,2,4,0.1,0.0
0.0032,0.1,0.075,4,8,4,0.5,2.0
0.0032,1.0,0,6,2,4,0.5,2.0
0.0001,1.0,0.075,4,8,16,0.1,2.0
0.0032,0.5,0,4,8,4,0.5,2.0
0.0032,0.5,0.075,6,2,4,0.1,0.0
0.0032,1.0,0,4,2,4,0.1,2.0
0.0032,0.1,0.075,6,2,16,0.1,0.0
0.0001,0.5,0,6,8,16,0.1,0.0
0.0032,0.1,0.075,6,2,16,0.1,2.0
0.0032,0.5,0,6,2,16,0.1,2.0
0.0032,0.5,0.075,6,2,4,0.1,2.0
0.0032,1.0,0.075,6,2,4,0.5,0.0
0.0032,0.1,0,6,2,4,0.1,2.0
0.0032,1.0,0,4,8,4,0.5,0.0
0.0032,0.5,0,6,2,4,0.1,0.0
0.0001,1.0,0,6,8,4,0.1,2.0
0.0032,0.5,0,6,2,4,0.1,2.0
0.0001,1.0,0.075,4,8,16,0.1,0.0
0.0032,0.1,0,4,2,16,0.1,2.0
0.0032,0.1,0.075,4,2,16,0.1,2.0
0.0032,1.0,0.075,6,2,4,0.5,2.0
0.0032,1.0,0.075,4,8,4,0.5,0.0
0.0001,0.5,0,6,8,16,0.1,2.0
0.0001,0.5,0.075,6,8,16,0.1,2.0
0.0001,0.1,0.075,6,8,16,0.1,2.0
0.0001,1.0,0.075,6,8,4,0.1,0.0
0.0032,0.5,0.075,4,8,16,0.5,0.0
0.0032,1.0,0,4,8,16,0.1,2.0
0.0032,0.1,0,4,2,16,0.1,0.0
0.0032,1.0,0,4,2,4,0.5,0.0
0.0032,0.1,0.075,6,2,4,0.1,2.0
0.0032,0.1,0,6,2,16,0.1,2.0
0.0032,1.0,0,4,2,4,0.1,0.0
0.0032,1.0,0,4,2,4,0.5,2.0
0.0001,1.0,0,6,8,4,0.1,0.0
0.0001,0.1,0,6,8,16,0.1,0.0
0.0032,1.0,0,4,2,16,0.5,2.0
0.0001,0.1,0.075,6,8,16,0.1,0.0
0.0001,1.0,0.075,6,8,4,0.1,2.0
0.0032,1.0,0,4,8,4,0.8,0.0
0.0032,0.5,0,4,2,16,0.1,0.0
0.0001,0.1,0,6,8,16,0.1,2.0
0.0032,1.0,0.075,4,2,4,0.5,0.0
0.0032,0.5,0,4,8,16,0.5,2.0
0.0032,0.5,0.075,4,8,16,0.5,2.0
0.0032,0.1,0.075,6,2,16,0.5,0.0
0.0001,1.0,0.075,4,8,4,0.1,0.0
0.0032,0.1,0.075,6,2,4,0.1,0.0
0.0032,0.5,0,4,2,4,0.1,0.0
0.0001,1.0,0.075,4,8,4,0.1,2.0
0.0032,0.5,0,4,2,4,0.1,2.0
0.0032,0.5,0,6,2,16,0.5,0.0
0.0032,0.1,0.075,4,2,4,0.1,2.0
0.0001,0.5,0.075,6,8,16,0.1,0.0
0.0032,1.0,0.075,6,2,16,0.5,0.0
0.0032,1.0,0,4,2,16,0.5,0.0
0.0001,0.5,0,4,8,16,0.1,2.0
0.0032,1.0,0,4,8,4,0.8,2.0
0.0001,0.1,0,4,8,16,0.1,2.0
0.0001,1.0,0,4,8,4,0.1,2.0
0.0032,0.1,0.075,4,2,16,0.1,0.0
0.0032,0.1,0,4,2,4,0.1,2.0
0.0032,0.1,0,4,2,4,0.1,0.0
0.0001,0.5,0,4,8,16,0.1,0.0
0.0032,0.1,0.075,4,8,16,0.5,0.0
0.0001,1.0,0,4,8,4,0.1,0.0
0.0001,1.0,0,6,2,16,0.1,2.0
0.0032,0.5,0.075,6,2,4,0.5,0.0
0.0032,0.1,0.075,4,8,16,0.5,2.0
0.0001,1.0,0.075,6,2,16,0.1,2.0
0.0032,0.1,0.075,6,2,4,0.5,2.0
0.0032,1.0,0.075,4,2,4,0.5,2.0
0.0032,0.5,0,4,2,16,0.1,2.0
0.0001,0.1,0.075,4,8,16,0.1,2.0
0.0032,0.5,0,4,2,16,0.5,0.0
0.0032,0.5,0.075,4,2,4,0.1,0.0
0.0001,1.0,0,6,2,16,0.1,0.0
0.0032,0.5,0.075,6,2,4,0.5,2.0
0.0032,0.1,0.075,6,2,16,0.5,2.0
0.0032,0.1,0,6,2,16,0.5,2.0
0.0032,1.0,0.075,4,2,16,0.5,0.0
0.0032,0.1,0.075,4,2,4,0.1,0.0
0.0001,0.5,0.075,6,8,4,0.1,0.0
0.0001,0.1,0.075,4,8,16,0.1,0.0
0.0001,0.5,0.075,4,8,16,0.1,0.0
0.0032,0.5,0,6,8,16,0.1,0.0
0.0032,1.0,0,4,2,4,0.8,0.0
0.0001,0.1,0,6,8,4,0.1,2.0
0.0032,0.5,0,6,2,4,0.5,0.0
0.0032,0.5,0.075,4,2,16,0.1,2.0
0.0032,0.1,0,6,2,4,0.5,2.0
0.0032,0.1,0,6,2,4,0.5,0.0
0.0001,0.5,0.075,6,8,4,0.1,2.0
0.0001,0.5,0,6,8,4,0.1,2.0
0.0032,0.5,0,6,8,4,0.5,2.0
0.0001,0.5,0.075,4,8,16,0.1,2.0
0.0032,1.0,0,6,2,4,0.8,0.0
0.0001,0.1,0,6,8,4,0.1,0.0
0.0032,1.0,0.075,6,2,4,0.8,0.0
0.0001,0.1,0.075,6,8,4,0.1,0.0
0.0032,0.1,0,4,2,4,0.5,2.0
0.0032,0.5,0,6,2,16,0.5,2.0
0.0032,0.5,0.075,4,2,4,0.1,2.0
0.0032,0.5,0,6,2,4,0.5,2.0
0.0032,0.5,0.075,6,2,16,0.5,0.0
0.0001,0.1,0.075,6,8,4,0.1,2.0
0.0001,0.5,0,6,8,4,0.1,0.0
0.0032,1.0,0.075,6,2,4,0.8,2.0
0.0032,1.0,0.075,4,2,4,0.8,2.0
0.0032,0.5,0.075,6,2,16,0.5,2.0
0.0001,1.0,0,6,8,16,0.5,2.0
0.0032,0.1,0.075,6,8,4,0.5,0.0
0.0032,0.1,0.075,6,2,4,0.5,0.0
0.0001,0.1,0,4,8,16,0.1,0.0
0.0032,1.0,0,6,2,4,0.8,2.0
0.0032,0.5,0.075,4,2,4,0.5,0.0
0.0032,1.0,0,4,2,4,0.8,2.0
0.0032,0.1,0.075,4,2,4,0.5,0.0
0.0001,1.0,0.075,6,2,4,0.1,2.0
0.0032,0.1,0.075,6,8,4,0.5,2.0
0.0032,0.1,0,6,2,4,0.8,0.0
0.0032,0.1,0.075,4,2,4,0.5,2.0
0.0032,0.5,0.075,4,2,16,0.5,0.0
0.0032,1.0,0,6,8,4,0.5,2.0
"""

# Parse configurations table into a list of dictionaries
configurations = []
reader = csv.DictReader(configurations_table.strip().splitlines())
for row in reader:
    configurations.append(row)

print(f"Total number of configurations: {len(configurations)}")

# Run each configuration from the configurations table
for combo_index, hyperparam_values in enumerate(configurations):
    # Build the command
    command = [
        "python", "run.py",
        "--kfolds", str(NUM_FOLDS),
        "--headless",
        "--jobid", str(combo_index),
        "--whichfold", "-1",
        "--lr", hyperparam_values["lr"],
        "--reptile_rate", hyperparam_values["reptile_rate"],
        "--mb", "20",
        "--noise", hyperparam_values["noise"],
        "--interpolate", DEFAULT_VALUES["interpolate"],
        "--num_heads", hyperparam_values["num_heads"],
        "--hidden_dim", DEFAULT_VALUES["hidden_dim"],
        "--attend_dim", hyperparam_values["attend_dim_per_head"],
        "--depth", hyperparam_values["depth"],
        "--ffn_dim_multiplier", DEFAULT_VALUES["ffn_dim_multiplier"],
        "--dropout", hyperparam_values["dropout"],
        "--ode_steps", DEFAULT_VALUES["ode_steps"],
        "--wd_factor", hyperparam_values["wd_factor"]
    ]

    # Print the command for debugging
    print("Command:", " ".join(command))

    # Execute the command
    try:
        subprocess.run(command, check=True)
    except subprocess.CalledProcessError as e:
        print(f"Error during execution: {e}")
        continue
